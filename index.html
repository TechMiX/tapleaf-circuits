<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
        <script src="https://unpkg.com/@cmdcode/tapscript@1.4.1"></script>
        <style>
            * {
                box-sizing: border-box;
                font-size: 1.15rem;
                font-family: Arial, sans-serif;
            }
            html {
                max-width: 70ch;
                padding: 3rem 1rem;
                margin: auto;
                line-height: 1.25;
            }
            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            input {
                line-height: 1.25;
                width: 100%;
                height: 1.8rem;
                font-size: 1.15rem;
                border: 1px solid grey;
            }
            .hidden {
                display: none;
            }
            .program {
                word-break: break-word;
            }
            .p_buttons {
                margin: 0.5rem;
            }
            @media screen and (max-width: 600px) {
            }
        </style>
        <script src="./scripts/utils.js"></script>
        <script src="./scripts/network.js"></script>
        <script src="./scripts/vm.js"></script>
        <script src="./scripts/circuits/bristol_zero_checker.js"></script>
        <script src="./scripts/circuits/bristol_size_checker.js"></script>
        <script src="./scripts/circuits/bristol_addition.js"></script>
        <script src="./scripts/main.js"></script>
    </head>
    <body>
        <div class="home">
            <h1>Welcome to BitVM Online</h1>
            <p>To run the bitvm there are seven steps:</p>
            <ol>
                <li>Pick a program</li>
                <li>Act as the prover to commit to a certain output</li>
                <li>Send money to the program</li>
                <li>Act as the prover to share which "inputs" make the code produce the expected output</li>
                <li>Act as the verifier to check if the code, with those inputs, produces the expected output</li>
                <li>If it does, act as the prover to take the money after a timelock</li>
                <li>Otherwise, act as the verifier to take the money by producing the error</li>
            </ol>
            <h2>Pick a program you want to run</h2>
            <p><button class="view_zero_checker p_buttons">Zero checker</button> <button class="view_size_checker p_buttons">Size checker</button> <button class="view_addition p_buttons">Addition</button></p>
            <div class="zero_checker hidden">
                <h3 class="zero_checker_label">
                    Zero checker
                </h3>
                <div class="zero_checker_instructions">
                    In this program, the prover must share a string of numbers with the verifier within a time limit, but not before making one of two promises: the string will only be 0s, or the string will *not* only be zeros. The verifier can take the prover's money if the promise is broken.
                </div>
                <p><button class="choose_zero_checker">Choose this program</button></p>
            </div>
            <div class="size_checker hidden">
                <h3 class="size_checker_label">
                    Size checker
                </h3>
                <div class="size_checker_instructions">
                    In this program, the prover must share two numbers with the verifier within a time limit, but not before making one of two promises: (1) the first number will be bigger than the second number, or (2) the first number will not be bigger than the second number. The verifier can take the prover's money if the promise is broken.
                </div>
                <p><button class="choose_size_checker">Choose this program</button></p>
            </div>
            <div class="addition hidden">
                <h3 class="addition_label">
                    Addition
                </h3>
                <div class="addition_instructions">
                    In this program, the prover must share a number with the verifier, then make a promise: within a time limit, they will share two numbers that sum to the original number. The verifier can take the prover's money if the promise is broken.
                </div>
                <p><button class="choose_addition">Choose this program</button></p>
            </div>
            <hr>
            <p><button class="view_caveats">View caveats</button></p>
            <ol class="caveats hidden">
                <li>This is a toy implementation, don't expect much.</li>
                <li>I wrote the VM in about 200 lines of javascript which means it barely works.</li>
                <li>It breaks if you put a program with more than about 3000 logic gates in it. <a href="https://github.com/supertestnet/tapleaf-circuits/" target="_blank">Help me write a better one!</a></li>
                <li>The whitepaper talks about using "binary search" in a challenge to find the shortest path to prove your counterparty is equivocating. I don't know how to program a binary search so I just didn't. Instead, if you challenge the prover, he has to *prove the entire computation himself, all on chain.* Which is very dumb, and expensive. But I wasn't trying to make it the smart way, I was trying to make it the easy way. Help  me improve it!</li>
                <li>If Paul doesn't send Vicky the data he promised, she is technically able to take his money after a 10 block timelock, but I didn't automatically give her a transaction for this like I did for Paul. So she's just out of luck til I do that. (Or you can figure out how to write bitcoin transactions manually and do it yourself.)</li>
                <li>Paul doesn't make Vicky pay him, or even check if her signatures on the presigned transactions are correct. He just yolos his money right into the bitvm address with no checks or balances, so Vicky can easily steal from him by just immediately moving it into the challenge address without presigning the transaction that lets him take it out again. Fixing that is on my todo list. So is having Vicky pay Paul for the computation.</li>
                <li>There are a bunch of other caveats but whatever, it technically works! I'm really looking forward to testing more functions with this. Bitcoin can run *anything* guys! Let's write some functions for it!</li>
            </ol>
        </div>
        <div class="zero_checker_program program hidden">
            <h1>Zero checker</h1>
            <div class="zero_checker_step_one">
                <p>
                    In this demo you will play as Paul, the prover. The first step is to open up the page where Vicky -- the verifier -- will verify your program, and copy her public key, and paste it here
                </p>
                <p>Visit Vicky's page: <a class="vicky_link" href="./vicky.html" target="_blank">Vicky page</a></p>
                <script>
                    $( '.vicky_link' ).href = "./vicky.html";
                    if ( $_GET[ "network" ] ) $( '.vicky_link' ).href = `./vicky.html?network=${$_GET[ "network" ]}`;
                </script>
                <p>Enter Vicky's public key</p>
                <p><input class="vickys_key"></p>
                <p><button class="zero_checker_step_one_done">Done</button></p>
            </div>
            <div class="zero_checker_step_two hidden">
                <p>
                    Time to make a promise to Vicky! Will your string be all 0s or not all zeros?
                </p>
                <select class="all_or_none">
                    <option>All 0s</option>
                    <option>Not all 0s</option>
                </select>
                <p><button class="submit_all_or_none">Download your promise file</button></p>
                <p>
                    Click ok when you've sent the promise file to Vicky
                </p>
                <p><button class="zero_checker_step_two_done">Done</button></p>
            </div>
            <div class="zero_checker_step_three hidden">
                <p>
                    Enter the bitcoin address where you want your money to go when you get it back:
                </p>
                <p><input class="zero_checker_bitcoin_address"></p>
                <p>
                    Also, it's time to validate that you and Vicky generated the same bitcoin addresses. Do all of these match what Vicky got? (Note: don't send any money to them yet)
                </p>
                <div class="address_validation">loading...</div>
                <p><button class="zero_checker_step_three_done">Yes, they match</button> <button class="zero_checker_step_three_reset">No, they don't match</button></p>
            </div>
            <div class="zero_checker_step_four hidden">
                <p>
                    Also, send *PRECISELY* 10,000 sats to the following address to start the contract (if you send the wrong amount it will not work):
                </p>
                <div class="funding_address_in_step_four">loading...</div>
                <p class="asking_for_txid">Asking for txid and vout in 3 seconds</p>
            </div>
            <div class="zero_checker_step_five hidden">
                <p>
                    Broadcast the following transaction to finalize the contract:
                </p>
                <div class="starter_txhex">loading...</div>
                <p><button class="zero_checker_step_five_done">Done</button></p>
            </div>
            <div class="zero_checker_step_six hidden">
                <p>
                    What string do you want to reveal to Vicky? Remember, you promised <span class="step_six_promise_to_vicky"></span> and she can take your money if you lie
                </p>
                <p><input class="zero_checker_revelation_string" maxlength="64" oninput="this.value=this.value.replace(/[^0-1]/,'')"></p>
                <p>Add this many more characters: <span class="zero_checker_chars_left">64</span></p>
                <p>Note that your string must only contain 0s and 1s</p>
                <p><button class="zero_checker_step_six_done">Submit</button></p>
            </div>
        </div>
        <div class="addition_program program hidden">
            <h1>Addition</h1>
            <div class="addition_step_one">
                <p>
                    In this demo you will play as Paul, the prover. The first step is to open up the page where Vicky -- the verifier -- will verify your program, and copy her public key, and paste it here
                </p>
                <p>Visit Vicky's page: <a class="vicky_link" href="./vicky.html" target="_blank">Vicky page</a></p>
                <script>
                    $( '.vicky_link' ).href = "./vicky.html";
                    if ( $_GET[ "network" ] ) $( '.vicky_link' ).href = `./vicky.html?network=${$_GET[ "network" ]}`;
                </script>
                <p>Enter Vicky's public key</p>
                <p><input class="vickys_key"></p>
                <p><button class="addition_step_one_done">Done</button></p>
            </div>
            <div class="addition_step_two hidden">
                <p>
                    Time to make a promise to Vicky! Enter a number. Later, you will need to enter two numbers that sum to this number.
                </p>
                <p><input class="sum_num" type="number" max="4294967295" min="0" step="1"></p>
                <p><button class="submit_sum_num">Download your promise file</button></p>
                <p>
                    Click ok when you've sent the promise file to Vicky
                </p>
                <p><button class="addition_step_two_done">Done</button></p>
            </div>
            <div class="addition_step_three hidden">
                <p>
                    Enter the bitcoin address where you want your money to go when you get it back:
                </p>
                <p><input class="addition_bitcoin_address"></p>
                <p>Hint: if you don't have a testnet wallet, you can just send it to a testnet faucet at this address:</p>
                <p>tb1q349k20q0yft6knyss5cdpcrgmg30taxyt5ggse</p>
                <p>
                    Also, it's time to validate that you and Vicky generated the same bitcoin addresses. Do all of these match what Vicky got? (Note: don't send any money to them yet)
                </p>
                <div class="address_validation">loading...</div>
                <p><button class="addition_step_three_done">Yes, they match</button> <button class="addition_step_three_reset">No, they don't match</button></p>
            </div>
            <div class="addition_step_four hidden">
                <p>
                    Send *PRECISELY* 10,000 sats to the following address to start the contract (if you send the wrong amount it will not work):
                </p>
                <div class="funding_address_in_step_four">loading...</div>
                <p class="asking_for_txid">Asking for txid and vout in 3 seconds</p>
            </div>
            <div class="addition_step_five hidden">
                <p>
                    Broadcast the following transaction to finalize the contract:
                </p>
                <div class="starter_txhex">loading...</div>
                <p><button class="addition_step_five_done">Done</button></p>
            </div>
            <div class="addition_step_six hidden">
                <p>
                    What two numbers do you want to reveal to Vicky? Remember, you promised they would add up to <span class="step_six_promise_to_vicky">loading...</span> and she can take your money if you lie
                </p>
                <p>Enter your first number</p>
                <p><input class="addition_num_1" type="number" max="4294967295" min="0" step="1"></p>
                <p>Enter your second number</p>
                <p><input class="addition_num_2" type="number" max="4294967295" min="0" step="1"></p>
                <p><button class="addition_step_six_done">Submit</button></p>
            </div>
        </div>
        <div class="size_checker_program program hidden">
            <h1>Size checker</h1>
            <div class="size_checker_step_one">
                <p>
                    In this demo you will play as Paul, the prover. The first step is to open up the page where Vicky -- the verifier -- will verify your program, and copy her public key, and paste it here
                </p>
                <p>Visit Vicky's page: <a class="vicky_link" href="./vicky.html" target="_blank">Vicky page</a></p>
                <script>
                    $( '.vicky_link' ).href = "./vicky.html";
                    if ( $_GET[ "network" ] ) $( '.vicky_link' ).href = `./vicky.html?network=${$_GET[ "network" ]}`;
                </script>
                <p>Enter Vicky's public key</p>
                <p><input class="vickys_key"></p>
                <p><button class="size_checker_step_one_done">Done</button></p>
            </div>
            <div class="size_checker_step_two hidden">
                <p>
                    Time to make a promise to Vicky! Enter a number and say whether it is bigger than a number you'll send Vicky later.
                </p>
                <p><input class="std_num" type="number" max="4294967295" min="0" step="1"></p>
                <p>
                    Will the number you just entered be bigger than the number you'll send Vicky later?
                </p>
                <select class="big_or_not">
                    <option>Bigger</option>
                    <option>Not bigger</option>
                </select>
                <p><button class="submit_std_num">Download your promise file</button></p>
                <p>
                    Click ok when you've sent the promise file to Vicky
                </p>
                <p><button class="size_checker_step_two_done">Done</button></p>
            </div>
            <div class="size_checker_step_three hidden">
                <p>
                    Enter the bitcoin address where you want your money to go when you get it back:
                </p>
                <p><input class="size_checker_bitcoin_address"></p>
                <p>Hint: if you don't have a testnet wallet, you can just send it to a testnet faucet at this address:</p>
                <p>tb1q349k20q0yft6knyss5cdpcrgmg30taxyt5ggse</p>
                <p>
                    Also, it's time to validate that you and Vicky generated the same bitcoin addresses. Do all of these match what Vicky got? (Note: don't send any money to them yet)
                </p>
                <div class="address_validation">loading...</div>
                <p><button class="size_checker_step_three_done">Yes, they match</button> <button class="size_checker_step_three_reset">No, they don't match</button></p>
            </div>
            <div class="size_checker_step_four hidden">
                <p>
                    Send *PRECISELY* 10,000 sats to the following address to start the contract (if you send the wrong amount it will not work):
                </p>
                <div class="funding_address_in_step_four">loading...</div>
                <p class="asking_for_txid">Asking for txid and vout in 3 seconds</p>
            </div>
            <div class="size_checker_step_five hidden">
                <p>
                    Broadcast the following transaction to finalize the contract:
                </p>
                <div class="starter_txhex">loading...</div>
                <p><button class="size_checker_step_five_done">Done</button></p>
            </div>
            <div class="size_checker_step_six hidden">
                <p>
                    What number do you want to reveal to Vicky? Remember, you promised Vicky your original number (<span class="step_six_second_promise_to_vicky">loading...</span>) would be "<span class="step_six_promise_to_vicky">loading...</span>" than the number you're about to enter. She can take your money if you lie.
                </p>
                <p>Enter your number of comparison</p>
                <p><input class="number_of_comparison" type="number" max="4294967295" min="0" step="1"></p>
                <p><button class="size_checker_step_six_done">Submit</button></p>
            </div>
        </div>
        <script>
            $( '.view_caveats' ).onclick = () => {
                if ( $( '.caveats' ).classList.contains( "hidden" ) ) $( '.caveats' ).classList.remove( "hidden" );
                else $( '.caveats' ).classList.add( "hidden" );
            }
            $( '.view_zero_checker' ).onclick = () => {
                $( '.zero_checker' ).classList.remove( "hidden" );
                $( '.size_checker' ).classList.add( "hidden" );
                $( '.addition' ).classList.add( "hidden" );
            }
            $( '.view_size_checker' ).onclick = () => {
                $( '.zero_checker' ).classList.add( "hidden" );
                $( '.size_checker' ).classList.remove( "hidden" );
                $( '.addition' ).classList.add( "hidden" );
            }
            $( '.view_addition' ).onclick = () => {
                $( '.zero_checker' ).classList.add( "hidden" );
                $( '.size_checker' ).classList.add( "hidden" );
                $( '.addition' ).classList.remove( "hidden" );
            }
            $( '.choose_zero_checker' ).onclick = async () => {
                $( '.zero_checker_program' ).classList.remove( "hidden" );
                $( '.home' ).classList.add( "hidden" );
                arrprep = bristol_curcuit_zero_checker;
                makeBristolArray();
                await setOperationsArray();
                await generateBitCommitments();
                operations_array.forEach( ( operation, index ) => {
                    if ( operation[ 0 ] == "INV" ) subsequent_commitment_preimages.push( [ operation[ 2 ][ 1 ], operation[ 2 ][ 2 ] ] );
                    if ( operation[ 0 ] == "INV" ) subsequent_commitment_hashes.push( [ operation[ 4 ][ 1 ], operation[ 4 ][ 2 ] ] );
                    if ( operation[ 0 ] == "AND" ) subsequent_commitment_preimages.push( [ operation[ 3 ][ 1 ], operation[ 3 ][ 2 ] ] );
                    if ( operation[ 0 ] == "AND" ) subsequent_commitment_hashes.push( [ operation[ 6 ][ 1 ], operation[ 6 ][ 2 ] ] );
                    if ( operation[ 0 ] == "XOR" ) subsequent_commitment_preimages.push( [ operation[ 3 ][ 1 ], operation[ 3 ][ 2 ] ] );
                    if ( operation[ 0 ] == "XOR" ) subsequent_commitment_hashes.push( [ operation[ 6 ][ 1 ], operation[ 6 ][ 2 ] ] );
                });
            }
            $( '.zero_checker_step_one_done' ).onclick = () => {
                $( '.zero_checker_step_one' ).classList.add( "hidden" );
                $( '.zero_checker_step_two' ).classList.remove( "hidden" );
                vickys_key = $( '.zero_checker_program .vickys_key' ).value;
            }
            $( '.submit_all_or_none' ).onclick = () => {
                promise = $( '.all_or_none' ).value;
                if ( promise == "All 0s" ) {
                    var output_preimages = [ subsequent_commitment_preimages[ subsequent_commitment_preimages.length - 1 ][ 1 ] ];
                } else {
                    var output_preimages = [ subsequent_commitment_preimages[ subsequent_commitment_preimages.length - 1 ][ 0 ] ];
                }
                var message_to_vicky = {
                    program: "zero checker",
                    promise,
                    pauls_key: pubkey,
                    initial_commitment_hashes,
                    subsequent_commitment_hashes,
                    output_preimages
                }
                saveData( JSON.stringify( message_to_vicky ), "promise_file.txt" );
            }
            $( '.zero_checker_step_two_done' ).onclick = () => {
                $( '.zero_checker_step_one' ).classList.add( "hidden" );
                $( '.zero_checker_step_two' ).classList.add( "hidden" );
                $( '.zero_checker_step_three' ).classList.remove( "hidden" );
                promise = $( '.all_or_none' ).value;
                $( '.zero_checker_program .step_six_promise_to_vicky' ).innerText = promise.toLowerCase();
                bit_commitment_address = generateBitCommitmentAddress( pubkey );
                anti_contradiction_address = generateAntiContradictionAddress( pubkey );
                challenge_address = generateChallengeAddress( pubkey );
                funding_address = generateFundingAddress( pubkey );
                var html = `
                    <p>Funding address: ${funding_address}</p>
                    <p>Bit commitment address: ${bit_commitment_address}</p>
                    <p>Anti contradiction address: ${anti_contradiction_address}</p>
                    <p>Challenge address: ${challenge_address}</p>
                `;
                $( '.zero_checker_program .address_validation' ).innerHTML = html;
            }
            $( '.zero_checker_step_three_reset' ).onclick = () => {
                alert( `Something must have gone wrong so it is not safe to continue. The page will reset.` );
                window.location.reload();
            }
            $( '.zero_checker_step_three_done' ).onclick = async () => {
                $( '.zero_checker_step_one' ).classList.add( "hidden" );
                $( '.zero_checker_step_two' ).classList.add( "hidden" );
                $( '.zero_checker_step_three' ).classList.add( "hidden" );
                $( '.zero_checker_step_four' ).classList.remove( "hidden" );
                $( '.zero_checker_program .funding_address_in_step_four' ).innerText = starter_address;
                console.log( "starter address:", starter_address );
                $( '.zero_checker_program .asking_for_txid' ).innerHTML = `If you are looking for testnet coins, try this faucet: <a href="https://faucet.mutinynet.com/" target="_blank">https://faucet.mutinynet.com</a>`;
                await waitSomeSeconds( 3 );
                if ( $_GET[ "network" ] == "regtest" ) {
                    var txid = prompt( `What was the txid?` );
                    var vout = prompt( `And the vout?` );
                    vout = Number( vout );
                } else {
                    await loopTilAddressReceivesMoney( starter_address, "" );
                    await waitSomeSeconds( 2 );
                    var txinfo = await addressReceivedMoneyInThisTx( starter_address, "" );
                    var txid = txinfo[ 0 ];
                    var vout = txinfo[ 1 ];
                }
                $( '.zero_checker_step_four' ).classList.add( "hidden" );
                $( '.zero_checker_step_five' ).classList.remove( "hidden" );
                var amt = 10_000;
                var starter_txdata = tapscript.Tx.create({
                  vin  : [{
                    txid: txid,
                    vout: vout,
                    prevout: {
                      value: amt,
                      scriptPubKey: [ 'OP_1', pubkey ]
                    },
                  }],
                  vout : [{
                    value: amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( funding_address ),
                  }]
                });

                var starter_sig = tapscript.Signer.taproot.sign( privkey, starter_txdata, 0 );
                starter_txdata.vin[0].witness = [ starter_sig ];
                await tapscript.Signer.taproot.verify( starter_txdata, 0, { throws: true });
                var starter_txhex = tapscript.Tx.encode( starter_txdata ).hex;
                starter_txid = tapscript.Tx.util.getTxid( starter_txhex );
                starter_vout = 0;
                starter_amt = 9_500;
                var destino = $( '.zero_checker_bitcoin_address' ).value;
                if ( !destino ) destino = prompt( `Please enter a bitcoin address where you want your earnings to go` );
                var earnings_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    sequence: 10,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( destino ),
                  }],
                });
                var earnings_sig = tapscript.Signer.taproot.sign( privkey, earnings_txdata, 0, { extension: funding_to_paul_tapleaf } );
                earnings_txdata.vin[0].witness = [ earnings_sig, funding_to_paul_script, funding_to_paul_cblock ];
                await tapscript.Signer.taproot.verify( earnings_txdata, 0, { pubkey, throws: true });
                earnings_txhex = tapscript.Tx.encode( earnings_txdata ).hex;
                //presign (1) a tx from the funding address to the bit commitment
                //address (2) a tx from the bit commitment address to the anti-contradiction
                //address (3) a tx from the bit commitment address to the challenge address
                //(4) a tx from the funding address to the anti-contradiction address (5)
                //a tx from the funding address to the challenge address
                //todo: Paul shouldn't put his money in the funding address til he has
                //validated sigs from Vicky letting him move his money *out of* the bit
                //commitment addresses and into the challenge address. Otherwise Vicky
                //might put his money *in* the bit commitment address but never let him
                //take it out.
                var funding_to_bit_commitment_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( bit_commitment_address ),
                  }],
                });
                var funding_to_bit_commitment_sig = tapscript.Signer.taproot.sign( privkey, funding_to_bit_commitment_txdata, 0, { extension: funding_to_anywhere_else_tapleaf } );
                var funding_to_anti_contradiction_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( anti_contradiction_address ),
                  }],
                });
                var funding_to_anti_contradiction_sig = tapscript.Signer.taproot.sign( privkey, funding_to_anti_contradiction_txdata, 0, { extension: funding_to_anywhere_else_tapleaf } );
                var funding_to_challenge_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( challenge_address ),
                  }],
                });
                var funding_to_challenge_sig = tapscript.Signer.taproot.sign( privkey, funding_to_challenge_txdata, 0, { extension: funding_to_anywhere_else_tapleaf } );
                var to_commitment_txhex = tapscript.Tx.encode( funding_to_bit_commitment_txdata ).hex;
                var to_commitment_txid = tapscript.Tx.util.getTxid( to_commitment_txhex );
                var to_commitment_vout = 0;
                var to_commitment_amt = 9_000;
                var commitment_to_anti_contradiction_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: to_commitment_txid,
                    vout: to_commitment_vout,
                    prevout: {
                      value: to_commitment_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( bit_commitment_address )
                    },
                  }],
                  vout: [{
                    value: to_commitment_amt - 3000,
                    scriptPubKey: tapscript.Address.toScriptPubKey( anti_contradiction_address ),
                  }],
                });
                var commitment_to_anti_contradiction_sig = tapscript.Signer.taproot.sign( privkey, commitment_to_anti_contradiction_txdata, 0, { extension: commitment_to_anywhere_else_tapleaf } );
                var commitment_to_challenge_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: to_commitment_txid,
                    vout: to_commitment_vout,
                    prevout: {
                      value: to_commitment_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( bit_commitment_address )
                    },
                  }],
                  vout: [{
                    value: to_commitment_amt - 3000,
                    scriptPubKey: tapscript.Address.toScriptPubKey( challenge_address ),
                  }],
                });
                var commitment_to_challenge_sig = tapscript.Signer.taproot.sign( privkey, commitment_to_challenge_txdata, 0, { extension: commitment_to_anywhere_else_tapleaf } );
                console.log( "starter txhex:", starter_txhex, "earnings_txhex:", earnings_txhex );
                //get the txid, vout, and amount left over from the starter tx and send them
                //to Vicky, then send the money into the funding address, then do the
                //computation and send Vicky the preimages and the signatures and the txid/
                //vout/amount of the tx from the starter address to the funding address
                //todo: prover shouldn't send his money anywhere til he gets paid to do so
                //by Vicky -- e.g. in an atomic swap where she gives him 5000 sats if he
                //puts his money in the funding address -- but she shouldn't do that til
                //she has the ability to move his money from the funding address to all of
                //these other addresses, so she should validate his signatures before doing
                //that swap. She should also independently construct all the txs above so
                //she has an independent copy of the sighashes to compare each sig against
                $( '.zero_checker_program .starter_txhex' ).innerText = starter_txhex;
                setTimeout( () => {pushBTCpmt( starter_txhex, "" );}, 2000 );
                $( '.zero_checker_step_five_done' ).click();
                presigned_tx_sigs = {
                    funding_to_bit_commitment_sig: funding_to_bit_commitment_sig.hex,
                    funding_to_anti_contradiction_sig: funding_to_anti_contradiction_sig.hex,
                    funding_to_challenge_sig: funding_to_challenge_sig.hex,
                    commitment_to_anti_contradiction_sig: commitment_to_anti_contradiction_sig.hex,
                    commitment_to_challenge_sig: commitment_to_challenge_sig.hex,
                }
            }
            $( '.zero_checker_step_five_done' ).onclick = async () => {
                $( '.zero_checker_step_five' ).classList.add( "hidden" );
                $( '.zero_checker_step_six' ).classList.remove( "hidden" );
            }
            $( '.zero_checker_step_six_done' ).onclick = async () => {
                var string = $( '.zero_checker_revelation_string' ).value;
                if ( string.length != 64 ) {
                    alert( `You didn't enter enough characters! Enter exactly 64 characters` );
                    return;
                }
                var stringarr = string.split( "" );
                stringarr.forEach( ( item, index ) => stringarr[ index ] = Number( item ) );
                initial_commitment_preimages.forEach( ( preimage_pair, index ) => {
                    wires.push( stringarr[ index ] );
                    preimages_to_reveal.push( preimage_pair[ stringarr[ index ] ] );
                });
                var i; for ( i=0; i<operations_array.length; i++ ) {
                    var fn_to_run = operations_array[ i ][ operations_array[ i ].length - 1 ].split( "= " )[ 1 ];
                    var preimage_to_reveal = eval( fn_to_run );
                    var output_wire = Number( operations_array[ i ][ operations_array[ i ].length - 1 ].split( " " )[ 1 ].substring( 2 ) );
                    wires[ output_wire ] = preimage_to_reveal;
                    preimage_to_reveal = Number( preimage_to_reveal ) + 1;
                    if ( operations_array[ i ][ 0 ] == "INV" ) preimages_to_reveal.push( operations_array[ i ][ 2 ][ preimage_to_reveal ] );
                    if ( operations_array[ i ][ 0 ] == "AND" ) preimages_to_reveal.push( operations_array[ i ][ 3 ][ preimage_to_reveal ] );
                    if ( operations_array[ i ][ 0 ] == "XOR" ) preimages_to_reveal.push( operations_array[ i ][ 3 ][ preimage_to_reveal ] );
                }
                var message_to_vicky = {
                    msg_type: "results",
                    starter_info: {
                        starter_txid,
                        starter_vout,
                        starter_amt,
                    },
                    preimages_to_reveal,
                    signatures: presigned_tx_sigs,
                }
                alert( `You are about to be prompted to download a file called results_file.txt. Do so and send it to Vicky.` );
                var blockheight = await getBlockheight( "" );
                saveData( JSON.stringify( message_to_vicky ), "results_file.txt" );
                $( '.zero_checker_step_six' ).innerHTML = `<p>After 10 blocks (so in block <span class="current_blockheight">${blockheight + 11}</span>) <a href="https://mutinynet.com/tx/push" target="_blank">go here</a> and broadcast this tx to collect your money if you sent the right data to Vicky (otherwise, expect Vicky to take your money):</p><p>${earnings_txhex}</p><p>While you wait, you can view the current blockheight here: <a href="https://mutinynet.com" target="_blank">https://mutinynet.com</a> (mutinynet is a bitcoin testnet where blocks arrive about every 30 seconds).</p>`;
            }
            $( '.zero_checker_program .vickys_key' ).value = "";
            $( '.zero_checker_revelation_string' ).value = "";
            $( '.zero_checker_revelation_string' ).onchange = () => {
                var length = $( '.zero_checker_revelation_string' ).value.length;
                $( '.zero_checker_chars_left' ).innerText = `${64 - length}`;
            }
            $( '.zero_checker_revelation_string' ).onkeyup = () => {
                var length = $( '.zero_checker_revelation_string' ).value.length;
                $( '.zero_checker_chars_left' ).innerText = `${64 - length}`;
            }
            //addition
            $( '.choose_addition' ).onclick = async () => {
                $( '.addition_program' ).classList.remove( "hidden" );
                $( '.home' ).classList.add( "hidden" );
                arrprep = bristol_circuit_addition;
                makeBristolArray();
                await setOperationsArray();
                await generateBitCommitments();
                operations_array.forEach( ( operation, index ) => {
                    if ( operation[ 0 ] == "INV" ) subsequent_commitment_preimages.push( [ operation[ 2 ][ 1 ], operation[ 2 ][ 2 ] ] );
                    if ( operation[ 0 ] == "INV" ) subsequent_commitment_hashes.push( [ operation[ 4 ][ 1 ], operation[ 4 ][ 2 ] ] );
                    if ( operation[ 0 ] == "AND" ) subsequent_commitment_preimages.push( [ operation[ 3 ][ 1 ], operation[ 3 ][ 2 ] ] );
                    if ( operation[ 0 ] == "AND" ) subsequent_commitment_hashes.push( [ operation[ 6 ][ 1 ], operation[ 6 ][ 2 ] ] );
                    if ( operation[ 0 ] == "XOR" ) subsequent_commitment_preimages.push( [ operation[ 3 ][ 1 ], operation[ 3 ][ 2 ] ] );
                    if ( operation[ 0 ] == "XOR" ) subsequent_commitment_hashes.push( [ operation[ 6 ][ 1 ], operation[ 6 ][ 2 ] ] );
                });
            }
            $( '.addition_step_one_done' ).onclick = () => {
                $( '.addition_step_one' ).classList.add( "hidden" );
                $( '.addition_step_two' ).classList.remove( "hidden" );
                vickys_key = $( '.addition_program .vickys_key' ).value;
            }
            $( '.submit_sum_num' ).onclick = () => {
                promise = Number( $( '.sum_num' ).value );
                var binary = promise.toString( 2 );
                if ( binary.length % 2 ) binary = "0" + binary;
                var padding = "0".repeat( 32 );
                binary = padding + binary;
                binary = binary.substring( binary.length - 32 );
                bin_array = binary.split( "" )
                bin_array.forEach( ( item, index ) => bin_array[ index ] = Number( item ) );
                var output_preimages = [];
                var i; for ( i=number_of_preimages_to_expect-number_of_outputs; i<number_of_preimages_to_expect; i++ ) {
                    var preimage = wire_settings[ String( i ) ][ bin_array[ ( i - number_of_preimages_to_expect ) + number_of_outputs ] ];
                    // console.log( i, ( i - number_of_preimages_to_expect ) + number_of_outputs, preimage );
                    output_preimages.push( preimage );
                }
                var message_to_vicky = {
                    program: "addition",
                    promise,
                    pauls_key: pubkey,
                    initial_commitment_hashes,
                    subsequent_commitment_hashes,
                    output_preimages
                }
                saveData( JSON.stringify( message_to_vicky ), "promise_file.txt" );
            }
            $( '.addition_step_two_done' ).onclick = () => {
                $( '.addition_step_one' ).classList.add( "hidden" );
                $( '.addition_step_two' ).classList.add( "hidden" );
                $( '.addition_step_three' ).classList.remove( "hidden" );
                promise = $( '.sum_num' ).value;
                $( '.addition_program .step_six_promise_to_vicky' ).innerText = promise.toLowerCase();
                bit_commitment_address = generateBitCommitmentAddress( pubkey );
                anti_contradiction_address = generateAntiContradictionAddress( pubkey );
                challenge_address = generateChallengeAddress( pubkey );
                funding_address = generateFundingAddress( pubkey );
                var html = `
                    <p>Funding address: ${funding_address}</p>
                    <p>Bit commitment address: ${bit_commitment_address}</p>
                    <p>Anti contradiction address: ${anti_contradiction_address}</p>
                    <p>Challenge address: ${challenge_address}</p>
                `;
                $( '.addition_program .address_validation' ).innerHTML = html;
            }
            $( '.addition_step_three_reset' ).onclick = () => {
                alert( `Something must have gone wrong so it is not safe to continue. The page will reset.` );
                window.location.reload();
            }
            $( '.addition_step_three_done' ).onclick = async () => {
                $( '.addition_step_one' ).classList.add( "hidden" );
                $( '.addition_step_two' ).classList.add( "hidden" );
                $( '.addition_step_three' ).classList.add( "hidden" );
                $( '.addition_step_four' ).classList.remove( "hidden" );
                $( '.addition_program .funding_address_in_step_four' ).innerText = starter_address;
                console.log( "starter address:", starter_address );
                $( '.addition_program .asking_for_txid' ).innerHTML = `If you are looking for testnet coins, try this faucet: <a href="https://faucet.mutinynet.com/" target="_blank">https://faucet.mutinynet.com</a>`;
                await waitSomeSeconds( 3 );
                if ( $_GET[ "network" ] == "regtest" ) {
                    var txid = prompt( `What was the txid?` );
                    var vout = prompt( `And the vout?` );
                    vout = Number( vout );
                } else {
                    await loopTilAddressReceivesMoney( starter_address, "" );
                    await waitSomeSeconds( 2 );
                    var txinfo = await addressReceivedMoneyInThisTx( starter_address, "" );
                    var txid = txinfo[ 0 ];
                    var vout = txinfo[ 1 ];
                }
                $( '.addition_step_four' ).classList.add( "hidden" );
                $( '.addition_step_five' ).classList.remove( "hidden" );
                var amt = 10_000;
                var starter_txdata = tapscript.Tx.create({
                  vin  : [{
                    txid: txid,
                    vout: vout,
                    prevout: {
                      value: amt,
                      scriptPubKey: [ 'OP_1', pubkey ]
                    },
                  }],
                  vout : [{
                    value: amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( funding_address ),
                  }]
                });

                var starter_sig = tapscript.Signer.taproot.sign( privkey, starter_txdata, 0 );
                starter_txdata.vin[0].witness = [ starter_sig ];
                await tapscript.Signer.taproot.verify( starter_txdata, 0, { throws: true });
                var starter_txhex = tapscript.Tx.encode( starter_txdata ).hex;
                starter_txid = tapscript.Tx.util.getTxid( starter_txhex );
                starter_vout = 0;
                starter_amt = 9_500;
                var destino = $( '.addition_bitcoin_address' ).value;
                if ( !destino ) destino = prompt( `Please enter a bitcoin address where you want your earnings to go` );
                var earnings_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    sequence: 10,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( destino ),
                  }],
                });
                var earnings_sig = tapscript.Signer.taproot.sign( privkey, earnings_txdata, 0, { extension: funding_to_paul_tapleaf } );
                earnings_txdata.vin[0].witness = [ earnings_sig, funding_to_paul_script, funding_to_paul_cblock ];
                await tapscript.Signer.taproot.verify( earnings_txdata, 0, { pubkey, throws: true });
                earnings_txhex = tapscript.Tx.encode( earnings_txdata ).hex;
                //presign (1) a tx from the funding address to the bit commitment
                //address (2) a tx from the bit commitment address to the anti-contradiction
                //address (3) a tx from the bit commitment address to the challenge address
                //(4) a tx from the funding address to the anti-contradiction address (5)
                //a tx from the funding address to the challenge address
                //todo: Paul shouldn't put his money in the funding address til he has
                //validated sigs from Vicky letting him move his money *out of* the bit
                //commitment addresses and into the challenge address. Otherwise Vicky
                //might put his money *in* the bit commitment address but never let him
                //take it out.
                var funding_to_bit_commitment_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( bit_commitment_address ),
                  }],
                });
                var funding_to_bit_commitment_sig = tapscript.Signer.taproot.sign( privkey, funding_to_bit_commitment_txdata, 0, { extension: funding_to_anywhere_else_tapleaf } );
                var funding_to_anti_contradiction_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( anti_contradiction_address ),
                  }],
                });
                var funding_to_anti_contradiction_sig = tapscript.Signer.taproot.sign( privkey, funding_to_anti_contradiction_txdata, 0, { extension: funding_to_anywhere_else_tapleaf } );
                var funding_to_challenge_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( challenge_address ),
                  }],
                });
                var funding_to_challenge_sig = tapscript.Signer.taproot.sign( privkey, funding_to_challenge_txdata, 0, { extension: funding_to_anywhere_else_tapleaf } );
                var to_commitment_txhex = tapscript.Tx.encode( funding_to_bit_commitment_txdata ).hex;
                var to_commitment_txid = tapscript.Tx.util.getTxid( to_commitment_txhex );
                var to_commitment_vout = 0;
                var to_commitment_amt = 9_000;
                var commitment_to_anti_contradiction_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: to_commitment_txid,
                    vout: to_commitment_vout,
                    prevout: {
                      value: to_commitment_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( bit_commitment_address )
                    },
                  }],
                  vout: [{
                    value: to_commitment_amt - 3000,
                    scriptPubKey: tapscript.Address.toScriptPubKey( anti_contradiction_address ),
                  }],
                });
                var commitment_to_anti_contradiction_sig = tapscript.Signer.taproot.sign( privkey, commitment_to_anti_contradiction_txdata, 0, { extension: commitment_to_anywhere_else_tapleaf } );
                var commitment_to_challenge_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: to_commitment_txid,
                    vout: to_commitment_vout,
                    prevout: {
                      value: to_commitment_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( bit_commitment_address )
                    },
                  }],
                  vout: [{
                    value: to_commitment_amt - 3000,
                    scriptPubKey: tapscript.Address.toScriptPubKey( challenge_address ),
                  }],
                });
                var commitment_to_challenge_sig = tapscript.Signer.taproot.sign( privkey, commitment_to_challenge_txdata, 0, { extension: commitment_to_anywhere_else_tapleaf } );
                console.log( "starter txhex:", starter_txhex, "earnings_txhex:", earnings_txhex );
                //get the txid, vout, and amount left over from the starter tx and send them
                //to Vicky, then send the money into the funding address, then do the
                //computation and send Vicky the preimages and the signatures and the txid/
                //vout/amount of the tx from the starter address to the funding address
                //todo: prover shouldn't send his money anywhere til he gets paid to do so
                //by Vicky -- e.g. in an atomic swap where she gives him 5000 sats if he
                //puts his money in the funding address -- but she shouldn't do that til
                //she has the ability to move his money from the funding address to all of
                //these other addresses, so she should validate his signatures before doing
                //that swap. She should also independently construct all the txs above so
                //she has an independent copy of the sighashes to compare each sig against
                $( '.addition_program .starter_txhex' ).innerText = starter_txhex;
                setTimeout( () => {pushBTCpmt( starter_txhex, "" );}, 2000 );
                $( '.addition_step_five_done' ).click();
                presigned_tx_sigs = {
                    funding_to_bit_commitment_sig: funding_to_bit_commitment_sig.hex,
                    funding_to_anti_contradiction_sig: funding_to_anti_contradiction_sig.hex,
                    funding_to_challenge_sig: funding_to_challenge_sig.hex,
                    commitment_to_anti_contradiction_sig: commitment_to_anti_contradiction_sig.hex,
                    commitment_to_challenge_sig: commitment_to_challenge_sig.hex,
                }
            }
            $( '.addition_step_five_done' ).onclick = async () => {
                $( '.addition_step_five' ).classList.add( "hidden" );
                $( '.addition_step_six' ).classList.remove( "hidden" );
            }
            $( '.addition_step_six_done' ).onclick = async () => {
                var num1 = Number( $( '.addition_num_1' ).value );
                var binary = num1.toString( 2 );
                if ( binary.length % 2 ) binary = "0" + binary;
                var padding = "0".repeat( 32 );
                binary = padding + binary;
                binary = binary.substring( binary.length - 32 );
                bin_array_1 = binary.split( "" )
                bin_array_1.forEach( ( item, index ) => bin_array_1[ index ] = Number( item ) );
                var num2 = Number( $( '.addition_num_2' ).value );
                var binary = num2.toString( 2 );
                if ( binary.length % 2 ) binary = "0" + binary;
                var padding = "0".repeat( 32 );
                binary = padding + binary;
                binary = binary.substring( binary.length - 32 );
                bin_array_2 = binary.split( "" )
                bin_array_2.forEach( ( item, index ) => bin_array_2[ index ] = Number( item ) );
                console.log( "num1:", bin_array_1.join( "" ), "num2:", bin_array_2.join( "" ) );
                initial_commitment_preimages.forEach( ( preimage_pair, index ) => {
                    if ( index < 32 ) {
                        wires.push( bin_array_1[ index ] );
                        preimages_to_reveal.push( preimage_pair[ bin_array_1[ index ] ] );
                    } else {
                        wires.push( bin_array_2[ index - 32 ] );
                        preimages_to_reveal.push( preimage_pair[ bin_array_2[ index - 32 ] ] );
                    }
                });
                console.log( "wires:", wires );
                var i; for ( i=0; i<operations_array.length; i++ ) {
                    var fn_to_run = operations_array[ i ][ operations_array[ i ].length - 1 ].split( "= " )[ 1 ];
                    var preimage_to_reveal = eval( fn_to_run );
                    var output_wire = Number( operations_array[ i ][ operations_array[ i ].length - 1 ].split( " " )[ 1 ].substring( 2 ) );
                    wires[ output_wire ] = preimage_to_reveal;
                    preimage_to_reveal = Number( preimage_to_reveal ) + 1;
                    if ( operations_array[ i ][ 0 ] == "INV" ) preimages_to_reveal.push( operations_array[ i ][ 2 ][ preimage_to_reveal ] );
                    if ( operations_array[ i ][ 0 ] == "AND" ) preimages_to_reveal.push( operations_array[ i ][ 3 ][ preimage_to_reveal ] );
                    if ( operations_array[ i ][ 0 ] == "XOR" ) preimages_to_reveal.push( operations_array[ i ][ 3 ][ preimage_to_reveal ] );
                }
                var message_to_vicky = {
                    msg_type: "results",
                    starter_info: {
                        starter_txid,
                        starter_vout,
                        starter_amt,
                    },
                    preimages_to_reveal,
                    signatures: presigned_tx_sigs,
                }
                alert( `You are about to be prompted to download a file called results_file.txt. Do so and send it to Vicky.` );
                var blockheight = await getBlockheight( "" );
                saveData( JSON.stringify( message_to_vicky ), "results_file.txt" );
                $( '.addition_step_six' ).innerHTML = `<p>After 10 blocks (so in block <span class="current_blockheight">${blockheight + 11}</span>) <a href="https://mutinynet.com/tx/push" target="_blank">go here</a> and broadcast this tx to collect your money if you sent the right data to Vicky (otherwise, expect Vicky to take your money):</p><p>${earnings_txhex}</p><p>While you wait, you can view the current blockheight here: <a href="https://mutinynet.com" target="_blank">https://mutinynet.com</a> (mutinynet is a bitcoin testnet where blocks arrive about every 30 seconds).</p>`;
            }
            $( '.addition_program .vickys_key' ).value = "";
            $( '.addition_program .sum_num' ).value = "";
            $( '.addition_program .addition_num_1' ).value = "";
            $( '.addition_program .addition_num_2' ).value = "";
            //Size checker
            $( '.choose_size_checker' ).onclick = async () => {
                $( '.size_checker_program' ).classList.remove( "hidden" );
                $( '.home' ).classList.add( "hidden" );
                arrprep = curcuit_bristol_size_checker;
                makeBristolArray();
                await setOperationsArray();
                await generateBitCommitments();
                operations_array.forEach( ( operation, index ) => {
                    if ( operation[ 0 ] == "INV" ) subsequent_commitment_preimages.push( [ operation[ 2 ][ 1 ], operation[ 2 ][ 2 ] ] );
                    if ( operation[ 0 ] == "INV" ) subsequent_commitment_hashes.push( [ operation[ 4 ][ 1 ], operation[ 4 ][ 2 ] ] );
                    if ( operation[ 0 ] == "AND" ) subsequent_commitment_preimages.push( [ operation[ 3 ][ 1 ], operation[ 3 ][ 2 ] ] );
                    if ( operation[ 0 ] == "AND" ) subsequent_commitment_hashes.push( [ operation[ 6 ][ 1 ], operation[ 6 ][ 2 ] ] );
                    if ( operation[ 0 ] == "XOR" ) subsequent_commitment_preimages.push( [ operation[ 3 ][ 1 ], operation[ 3 ][ 2 ] ] );
                    if ( operation[ 0 ] == "XOR" ) subsequent_commitment_hashes.push( [ operation[ 6 ][ 1 ], operation[ 6 ][ 2 ] ] );
                });
            }
            $( '.size_checker_step_one_done' ).onclick = () => {
                $( '.size_checker_step_one' ).classList.add( "hidden" );
                $( '.size_checker_step_two' ).classList.remove( "hidden" );
                vickys_key = $( '.size_checker_program .vickys_key' ).value;
            }
            $( '.submit_std_num' ).onclick = () => {
                var std_num = Number( $( '.std_num' ).value );
                var binary = std_num.toString( 2 );
                if ( binary.length % 2 ) binary = "0" + binary;
                var padding = "0".repeat( 32 );
                binary = padding + binary;
                binary = binary.substring( binary.length - 32 );
                binary = reverseString( binary );
                bin_array = binary.split( "" );
                bin_array.forEach( ( item, index ) => bin_array[ index ] = Number( item ) );
                promise = [ std_num, $( '.big_or_not' ).value ];
                var output_preimages = [];
                //reveal the preimage for "false" (0) if the first number is "bigger"
                //because the function returns true if the first number is "less
                //than or equal to" the second number, which is the same thing as
                //returning false if the first number is "bigger"
                var setting = $( '.big_or_not' ).value.toLowerCase() == "bigger" ? 0:1;
                var preimage = wire_settings[ String( number_of_preimages_to_expect-number_of_outputs ) ][ setting ];
                output_preimages.push( preimage );
                var message_to_vicky = {
                    program: "size checker",
                    promise,
                    pauls_key: pubkey,
                    initial_commitment_hashes,
                    subsequent_commitment_hashes,
                    output_preimages
                }
                saveData( JSON.stringify( message_to_vicky ), "promise_file.txt" );
            }
            $( '.size_checker_step_two_done' ).onclick = () => {
                $( '.size_checker_step_one' ).classList.add( "hidden" );
                $( '.size_checker_step_two' ).classList.add( "hidden" );
                $( '.size_checker_step_three' ).classList.remove( "hidden" );
                var std_num = Number( $( '.std_num' ).value );
                promise = [ std_num, $( '.big_or_not' ).value ];
                var partial_promise = promise[ 1 ].toLowerCase();
                if ( partial_promise == "not bigger" ) partial_promise = "equal to or less";
                $( '.size_checker_program .step_six_promise_to_vicky' ).innerText = promise[ 1 ].toLowerCase();
                $( '.size_checker_program .step_six_second_promise_to_vicky' ).innerText = promise[ 0 ];
                bit_commitment_address = generateBitCommitmentAddress( pubkey );
                anti_contradiction_address = generateAntiContradictionAddress( pubkey );
                challenge_address = generateChallengeAddress( pubkey );
                funding_address = generateFundingAddress( pubkey );
                var html = `
                    <p>Funding address: ${funding_address}</p>
                    <p>Bit commitment address: ${bit_commitment_address}</p>
                    <p>Anti contradiction address: ${anti_contradiction_address}</p>
                    <p>Challenge address: ${challenge_address}</p>
                `;
                $( '.size_checker_program .address_validation' ).innerHTML = html;
            }
            $( '.size_checker_step_three_reset' ).onclick = () => {
                alert( `Something must have gone wrong so it is not safe to continue. The page will reset.` );
                window.location.reload();
            }
            $( '.size_checker_step_three_done' ).onclick = async () => {
                $( '.size_checker_step_one' ).classList.add( "hidden" );
                $( '.size_checker_step_two' ).classList.add( "hidden" );
                $( '.size_checker_step_three' ).classList.add( "hidden" );
                $( '.size_checker_step_four' ).classList.remove( "hidden" );
                $( '.size_checker_program .funding_address_in_step_four' ).innerText = starter_address;
                console.log( "starter address:", starter_address );
                $( '.size_checker_program .asking_for_txid' ).innerHTML = `If you are looking for testnet coins, try this faucet: <a href="https://faucet.mutinynet.com/" target="_blank">https://faucet.mutinynet.com</a>`;
                await waitSomeSeconds( 3 );
                if ( $_GET[ "network" ] == "regtest" ) {
                    var txid = prompt( `What was the txid?` );
                    var vout = prompt( `And the vout?` );
                    vout = Number( vout );
                } else {
                    await loopTilAddressReceivesMoney( starter_address, "" );
                    await waitSomeSeconds( 2 );
                    var txinfo = await addressReceivedMoneyInThisTx( starter_address, "" );
                    var txid = txinfo[ 0 ];
                    var vout = txinfo[ 1 ];
                }
                $( '.size_checker_step_four' ).classList.add( "hidden" );
                $( '.size_checker_step_five' ).classList.remove( "hidden" );
                var amt = 10_000;
                var starter_txdata = tapscript.Tx.create({
                  vin  : [{
                    txid: txid,
                    vout: vout,
                    prevout: {
                      value: amt,
                      scriptPubKey: [ 'OP_1', pubkey ]
                    },
                  }],
                  vout : [{
                    value: amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( funding_address ),
                  }]
                });

                var starter_sig = tapscript.Signer.taproot.sign( privkey, starter_txdata, 0 );
                starter_txdata.vin[0].witness = [ starter_sig ];
                await tapscript.Signer.taproot.verify( starter_txdata, 0, { throws: true });
                var starter_txhex = tapscript.Tx.encode( starter_txdata ).hex;
                starter_txid = tapscript.Tx.util.getTxid( starter_txhex );
                starter_vout = 0;
                starter_amt = 9_500;
                var destino = $( '.size_checker_bitcoin_address' ).value;
                if ( !destino ) destino = prompt( `Please enter a bitcoin address where you want your earnings to go` );
                var earnings_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    sequence: 10,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( destino ),
                  }],
                });
                var earnings_sig = tapscript.Signer.taproot.sign( privkey, earnings_txdata, 0, { extension: funding_to_paul_tapleaf } );
                earnings_txdata.vin[0].witness = [ earnings_sig, funding_to_paul_script, funding_to_paul_cblock ];
                await tapscript.Signer.taproot.verify( earnings_txdata, 0, { pubkey, throws: true });
                earnings_txhex = tapscript.Tx.encode( earnings_txdata ).hex;
                //presign (1) a tx from the funding address to the bit commitment
                //address (2) a tx from the bit commitment address to the anti-contradiction
                //address (3) a tx from the bit commitment address to the challenge address
                //(4) a tx from the funding address to the anti-contradiction address (5)
                //a tx from the funding address to the challenge address
                //todo: Paul shouldn't put his money in the funding address til he has
                //validated sigs from Vicky letting him move his money *out of* the bit
                //commitment addresses and into the challenge address. Otherwise Vicky
                //might put his money *in* the bit commitment address but never let him
                //take it out.
                var funding_to_bit_commitment_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( bit_commitment_address ),
                  }],
                });
                var funding_to_bit_commitment_sig = tapscript.Signer.taproot.sign( privkey, funding_to_bit_commitment_txdata, 0, { extension: funding_to_anywhere_else_tapleaf } );
                var funding_to_anti_contradiction_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( anti_contradiction_address ),
                  }],
                });
                var funding_to_anti_contradiction_sig = tapscript.Signer.taproot.sign( privkey, funding_to_anti_contradiction_txdata, 0, { extension: funding_to_anywhere_else_tapleaf } );
                var funding_to_challenge_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: starter_txid,
                    vout: starter_vout,
                    prevout: {
                      value: starter_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( funding_address )
                    },
                  }],
                  vout: [{
                    value: starter_amt - 500,
                    scriptPubKey: tapscript.Address.toScriptPubKey( challenge_address ),
                  }],
                });
                var funding_to_challenge_sig = tapscript.Signer.taproot.sign( privkey, funding_to_challenge_txdata, 0, { extension: funding_to_anywhere_else_tapleaf } );
                var to_commitment_txhex = tapscript.Tx.encode( funding_to_bit_commitment_txdata ).hex;
                var to_commitment_txid = tapscript.Tx.util.getTxid( to_commitment_txhex );
                var to_commitment_vout = 0;
                var to_commitment_amt = 9_000;
                var commitment_to_anti_contradiction_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: to_commitment_txid,
                    vout: to_commitment_vout,
                    prevout: {
                      value: to_commitment_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( bit_commitment_address )
                    },
                  }],
                  vout: [{
                    value: to_commitment_amt - 3000,
                    scriptPubKey: tapscript.Address.toScriptPubKey( anti_contradiction_address ),
                  }],
                });
                var commitment_to_anti_contradiction_sig = tapscript.Signer.taproot.sign( privkey, commitment_to_anti_contradiction_txdata, 0, { extension: commitment_to_anywhere_else_tapleaf } );
                var commitment_to_challenge_txdata = tapscript.Tx.create({
                  vin: [{
                    txid: to_commitment_txid,
                    vout: to_commitment_vout,
                    prevout: {
                      value: to_commitment_amt,
                      scriptPubKey: tapscript.Address.toScriptPubKey( bit_commitment_address )
                    },
                  }],
                  vout: [{
                    value: to_commitment_amt - 3000,
                    scriptPubKey: tapscript.Address.toScriptPubKey( challenge_address ),
                  }],
                });
                var commitment_to_challenge_sig = tapscript.Signer.taproot.sign( privkey, commitment_to_challenge_txdata, 0, { extension: commitment_to_anywhere_else_tapleaf } );
                console.log( "starter txhex:", starter_txhex, "earnings_txhex:", earnings_txhex );
                //get the txid, vout, and amount left over from the starter tx and send them
                //to Vicky, then send the money into the funding address, then do the
                //computation and send Vicky the preimages and the signatures and the txid/
                //vout/amount of the tx from the starter address to the funding address
                //todo: prover shouldn't send his money anywhere til he gets paid to do so
                //by Vicky -- e.g. in an atomic swap where she gives him 5000 sats if he
                //puts his money in the funding address -- but she shouldn't do that til
                //she has the ability to move his money from the funding address to all of
                //these other addresses, so she should validate his signatures before doing
                //that swap. She should also independently construct all the txs above so
                //she has an independent copy of the sighashes to compare each sig against
                $( '.size_checker_program .starter_txhex' ).innerText = starter_txhex;
                setTimeout( () => {pushBTCpmt( starter_txhex, "" );}, 2000 );
                $( '.size_checker_step_five_done' ).click();
                presigned_tx_sigs = {
                    funding_to_bit_commitment_sig: funding_to_bit_commitment_sig.hex,
                    funding_to_anti_contradiction_sig: funding_to_anti_contradiction_sig.hex,
                    funding_to_challenge_sig: funding_to_challenge_sig.hex,
                    commitment_to_anti_contradiction_sig: commitment_to_anti_contradiction_sig.hex,
                    commitment_to_challenge_sig: commitment_to_challenge_sig.hex,
                }
            }
            $( '.size_checker_step_five_done' ).onclick = async () => {
                $( '.size_checker_step_five' ).classList.add( "hidden" );
                $( '.size_checker_step_six' ).classList.remove( "hidden" );
            }
            $( '.size_checker_step_six_done' ).onclick = async () => {
                //the function returns true if the first number (the standard
                //number) is less than or equal to the second number
                //i.e. it returns false if the first number is
                //bigger than the second number
                var standard_number = Number( $( '.std_num' ).value );
                var number_of_comparison = Number( $( '.number_of_comparison' ).value );
                var binary = standard_number.toString( 2 );
                if ( binary.length % 2 ) binary = "0" + binary;
                var padding = "0".repeat( 32 );
                binary = padding + binary;
                binary = binary.substring( binary.length - 32 );
                binary = reverseString( binary );
                bin_array_1 = binary.split( "" );
                bin_array_1.forEach( ( item, index ) => bin_array_1[ index ] = Number( item ) );
                var binary = number_of_comparison.toString( 2 );
                if ( binary.length % 2 ) binary = "0" + binary;
                var padding = "0".repeat( 32 );
                binary = padding + binary;
                binary = binary.substring( binary.length - 32 );
                binary = reverseString( binary );
                bin_array_2 = binary.split( "" );
                bin_array_2.forEach( ( item, index ) => bin_array_2[ index ] = Number( item ) );
                console.log( "standard number:", bin_array_1.join( "" ), "number of comparison:", bin_array_2.join( "" ) );
                console.log( "remember, the function returns true if the second number is bigger than the first number" );
                initial_commitment_preimages.forEach( ( preimage_pair, index ) => {
                    if ( index < 32 ) {
                        wires.push( bin_array_1[ index ] );
                        preimages_to_reveal.push( preimage_pair[ bin_array_1[ index ] ] );
                    } else {
                        wires.push( bin_array_2[ index - 32 ] );
                        preimages_to_reveal.push( preimage_pair[ bin_array_2[ index - 32 ] ] );
                    }
                });
                console.log( "wires:", wires );
                var i; for ( i=0; i<operations_array.length; i++ ) {
                    var fn_to_run = operations_array[ i ][ operations_array[ i ].length - 1 ].split( "= " )[ 1 ];
                    var preimage_to_reveal = eval( fn_to_run );
                    var output_wire = Number( operations_array[ i ][ operations_array[ i ].length - 1 ].split( " " )[ 1 ].substring( 2 ) );
                    wires[ output_wire ] = preimage_to_reveal;
                    preimage_to_reveal = Number( preimage_to_reveal ) + 1;
                    if ( operations_array[ i ][ 0 ] == "INV" ) preimages_to_reveal.push( operations_array[ i ][ 2 ][ preimage_to_reveal ] );
                    if ( operations_array[ i ][ 0 ] == "AND" ) preimages_to_reveal.push( operations_array[ i ][ 3 ][ preimage_to_reveal ] );
                    if ( operations_array[ i ][ 0 ] == "XOR" ) preimages_to_reveal.push( operations_array[ i ][ 3 ][ preimage_to_reveal ] );
                }
                var message_to_vicky = {
                    msg_type: "results",
                    starter_info: {
                        starter_txid,
                        starter_vout,
                        starter_amt,
                    },
                    preimages_to_reveal,
                    signatures: presigned_tx_sigs,
                }
                alert( `You are about to be prompted to download a file called results_file.txt. Do so and send it to Vicky.` );
                var blockheight = await getBlockheight( "" );
                saveData( JSON.stringify( message_to_vicky ), "results_file.txt" );
                $( '.size_checker_step_six' ).innerHTML = `<p>After 10 blocks (so in block <span class="current_blockheight">${blockheight + 11}</span>) <a href="https://mutinynet.com/tx/push" target="_blank">go here</a> and broadcast this tx to collect your money if you sent the right data to Vicky (otherwise, expect Vicky to take your money):</p><p>${earnings_txhex}</p><p>While you wait, you can view the current blockheight here: <a href="https://mutinynet.com" target="_blank">https://mutinynet.com</a> (mutinynet is a bitcoin testnet where blocks arrive about every 30 seconds).</p>`;
            }
            $( '.size_checker_program .vickys_key' ).value = "";
            $( '.size_checker_program .std_num' ).value = "";
            $( '.size_checker_program .number_of_comparison' ).value = ""
        </script>
    </body>
</html>
